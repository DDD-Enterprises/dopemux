# Dopemux MCP Servers - Complete Docker Orchestration
# Based on ADR-007 (Routing Logic) and ADR-012 (MCP Integration Patterns)

services:
  # === CRITICAL PATH SERVERS (Priority: High) ===

  # Context7 - ALWAYS FIRST for documentation and API references
  context7:
    image: mcp/context7:latest
    container_name: mcp-context7
    restart: unless-stopped
    networks:
      - mcp-network
    environment:
      - CONTEXT7_API_KEY=${CONTEXT7_API_KEY}
      - CONTEXT7_ENDPOINT=${CONTEXT7_ENDPOINT}
    ports:
      - "3002:8080"
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8080"]
      timeout: 10s
      retries: 3
      interval: 30s
      start_period: 30s
    volumes:
      - mcp_context7_cache:/app/cache
    labels:
      - "mcp.role=critical_path"
      - "mcp.priority=highest"
      - "mcp.description=Documentation and API references"

  # Zen - Multi-model orchestration and complex decision making
  zen:
    build:
      context: ./zen
      dockerfile: Dockerfile
    container_name: mcp-zen
    restart: unless-stopped
    networks:
      - mcp-network
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - DISABLED_TOOLS=analyze,refactor,testgen,secaudit,docgen,tracer
      - DEFAULT_MODEL=auto
      - MCP_SERVER_PORT=3003
    ports:
      - "3003:3003"
    working_dir: /app
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      timeout: 10s
      retries: 3
      interval: 30s
      start_period: 30s
    labels:
      - "mcp.role=critical_path"
      - "mcp.priority=highest"
      - "mcp.description=Multi-model orchestration"

  # Sequential Thinking - Multi-step reasoning and architectural analysis
  mas-sequential-thinking:
    build:
      context: ./mcp-server-mas-sequential-thinking
      dockerfile: Dockerfile
    container_name: mcp-mas-sequential-thinking
    restart: unless-stopped
    networks:
      - mcp-network
    env_file:
      - ./mcp-server-mas-sequential-thinking/.env
    ports:
      - "3001:3001"
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      timeout: 10s
      retries: 3
      interval: 30s
      start_period: 30s
    volumes:
      - mcp_logs:/app/logs
      - mcp_cache:/app/cache
    labels:
      - "mcp.role=critical_path"
      - "mcp.priority=high"
      - "mcp.description=Multi-step reasoning and analysis"

  # === WORKFLOW SERVERS (Priority: Medium) ===

  # ConPort - Project memory and decision tracking
  conport:
    build:
      context: ./conport
      dockerfile: Dockerfile
    container_name: mcp-conport
    restart: unless-stopped
    networks:
      - mcp-network
    environment:
      - MCP_SERVER_PORT=3004
    ports:
      - "3004:3004"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3004/health"]
      timeout: 10s
      retries: 3
      interval: 30s
      start_period: 30s
    volumes:
      - mcp_conport_data:/app/data
    labels:
      - "mcp.role=workflow"
      - "mcp.priority=medium"
      - "mcp.description=Project memory and decision tracking"

  # Task Master AI - Task management and PRD processing
  task-master-ai:
    build:
      context: ./task-master-ai
      dockerfile: Dockerfile
    container_name: mcp-task-master-ai
    restart: unless-stopped
    networks:
      - mcp-network
    environment:
      - MCP_SERVER_PORT=3005
    ports:
      - "3005:3005"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3005/health"]
      timeout: 10s
      retries: 3
      interval: 30s
      start_period: 30s
    volumes:
      - mcp_task_master_data:/app/data
    labels:
      - "mcp.role=workflow"
      - "mcp.priority=medium"
      - "mcp.description=Task management and PRD processing"

  # Serena - Code navigation, refactoring, LSP functionality
  serena:
    build:
      context: ./serena
      dockerfile: Dockerfile
    container_name: mcp-serena
    restart: unless-stopped
    networks:
      - mcp-network
    environment:
      - MCP_SERVER_PORT=3006
    ports:
      - "3006:3006"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3006/health || exit 1"]
      timeout: 10s
      retries: 3
      interval: 30s
      start_period: 60s
    volumes:
      - mcp_serena_data:/app/data
    labels:
      - "mcp.role=workflow"
      - "mcp.priority=medium"
      - "mcp.description=Code navigation and refactoring"

  # Milvus dependencies
  etcd:
    container_name: milvus-etcd
    image: quay.io/coreos/etcd:v3.5.5
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
    volumes:
      - etcd_data:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - mcp-network

  minio:
    container_name: milvus-minio
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    ports:
      - "9001:9001"
      - "9000:9000"
    volumes:
      - minio_data:/minio_data
    command: minio server /minio_data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - mcp-network

  # Milvus - Vector database for claude-context
  milvus:
    image: milvusdb/milvus:latest
    container_name: milvus-standalone
    restart: unless-stopped
    networks:
      - mcp-network
    ports:
      - "19530:19530"
      - "9091:9091"
    volumes:
      - milvus_data:/var/lib/milvus
    environment:
      - ETCD_ENDPOINTS=etcd:2379
      - MINIO_ADDRESS=minio:9000
    command: milvus run standalone
    depends_on:
      etcd:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9091/healthz || exit 1"]
      timeout: 10s
      retries: 5
      interval: 30s
      start_period: 90s

  # Claude Context - Semantic code search within repositories
  claude-context:
    build:
      context: ./claude-context
      dockerfile: Dockerfile
    container_name: mcp-claude-context
    restart: unless-stopped
    networks:
      - mcp-network
    environment:
      - EMBEDDING_PROVIDER=VoyageAI
      - EMBEDDING_MODEL=voyage-code-3
      - VOYAGEAI_API_KEY=${VOYAGEAI_API_KEY}
      - VOYAGEAI_RERANK_MODEL=rerank-2.5
      - MILVUS_ADDRESS=milvus:19530
      - MILVUS_TOKEN=
      - MCP_SERVER_PORT=3007
    ports:
      - "3007:3007"
    depends_on:
      milvus:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3007/health || exit 1"]
      timeout: 10s
      retries: 3
      interval: 30s
      start_period: 60s
    volumes:
      - mcp_claude_context_data:/app/data
      - mcp_claude_context_cache:/root/.context
      - /Users/hue/code/dopemux-mvp:/workspace/dopemux-mvp:ro
    labels:
      - "mcp.role=research"
      - "mcp.priority=medium"
      - "mcp.description=Semantic code search"

  # === RESEARCH SERVERS (Priority: Low - Fallback Only) ===

  # DocRAG - Document semantic search with Milvus and Voyage AI
  docrag:
    build:
      context: ./docrag-service
      dockerfile: Dockerfile
    container_name: mcp-docrag
    restart: unless-stopped
    networks:
      - mcp-network
    environment:
      - VOYAGEAI_API_KEY=${VOYAGEAI_API_KEY}
      - VOYAGE__API_KEY=${VOYAGEAI_API_KEY}
      - MILVUS__HOST=milvus
      - MILVUS__PORT=19530
      - DOCRAG_PORT=3009
      - ENABLE_HYBRID_SEARCH=true
      - ENABLE_RERANKING=true
      - LOG_LEVEL=INFO
    ports:
      - "3009:3009"
    depends_on:
      milvus:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3009/health"]
      timeout: 10s
      retries: 3
      interval: 30s
      start_period: 60s
    volumes:
      - mcp_docrag_data:/app/data
      - /Users/hue/code/dopemux-mvp:/workspace/dopemux-mvp:ro
    labels:
      - "mcp.role=research"
      - "mcp.priority=medium"
      - "mcp.description=Document semantic search"

  # Exa - Web research (ONLY when context7 lacks information)
  exa:
    build:
      context: ./exa
      dockerfile: Dockerfile
    container_name: mcp-exa
    restart: unless-stopped
    networks:
      - mcp-network
    environment:
      - EXA_API_KEY=${EXA_API_KEY}
      - MCP_SERVER_PORT=3008
    ports:
      - "3008:3008"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3008/health || exit 1"]
      timeout: 10s
      retries: 3
      interval: 30s
      start_period: 30s
    labels:
      - "mcp.role=research"
      - "mcp.priority=low"
      - "mcp.description=Web research fallback"

  # === QUALITY & UTILITY SERVERS (Priority: Medium) ===

  # MorphLLM Fast Apply - Pattern-based transformations and bulk edits
  morphllm-fast-apply:
    build:
      context: ./morphllm-fast-apply
      dockerfile: Dockerfile
    container_name: mcp-morphllm-fast-apply
    restart: unless-stopped
    networks:
      - mcp-network
    environment:
      - MCP_SERVER_PORT=3011
    ports:
      - "3011:3011"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3011/health"]
      timeout: 10s
      retries: 3
      interval: 30s
      start_period: 30s
    labels:
      - "mcp.role=quality"
      - "mcp.priority=medium"
      - "mcp.description=Pattern-based transformations and bulk edits"

  # Desktop Commander - Desktop automation and system control
  desktop-commander:
    build:
      context: ./desktop-commander
      dockerfile: Dockerfile
    container_name: mcp-desktop-commander
    restart: unless-stopped
    networks:
      - mcp-network
    environment:
      - MCP_SERVER_PORT=3012
      - DISPLAY=${DISPLAY:-:0}
    ports:
      - "3012:3012"
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /tmp:/tmp
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3012/health"]
      timeout: 10s
      retries: 3
      interval: 30s
      start_period: 30s
    labels:
      - "mcp.role=utility"
      - "mcp.priority=medium"
      - "mcp.description=Desktop automation and system control"

  # ClearThought - Structured reasoning and decision frameworks
  clear-thought:
    image: node:18-alpine
    container_name: mcp-clear-thought
    restart: unless-stopped
    networks:
      - mcp-network
    environment:
      - CLEAR_THOUGHT_TELEMETRY=off
      - MCP_SERVER_PORT=3013
    ports:
      - "3013:3013"
    working_dir: /app
    command: ["npx", "-y", "@waldzellai/clear-thought-onepointfive"]
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 3013 || exit 1"]
      timeout: 10s
      retries: 3
      interval: 30s
      start_period: 60s
    labels:
      - "mcp.role=reasoning"
      - "mcp.priority=high"
      - "mcp.description=Structured reasoning and decision frameworks"

# === NETWORKS ===
networks:
  mcp-network:
    driver: bridge
    name: mcp-network
    ipam:
      config:
        - subnet: 172.20.0.0/16
  # Connect to existing Leantime network for PM integration
  leantime-net:
    external: true
    name: leantime-net

# === VOLUMES ===
volumes:
  mcp_logs:
    driver: local
    name: mcp_logs
  mcp_cache:
    driver: local
    name: mcp_cache
  mcp_context7_cache:
    driver: local
    name: mcp_context7_cache
  mcp_conport_data:
    driver: local
    name: mcp_conport_data
  mcp_task_master_data:
    driver: local
    name: mcp_task_master_data
  mcp_serena_data:
    driver: local
    name: mcp_serena_data
  mcp_claude_context_data:
    driver: local
    name: mcp_claude_context_data
  mcp_claude_context_cache:
    driver: local
    name: mcp_claude_context_cache
  mcp_docrag_data:
    driver: local
    name: mcp_docrag_data
  milvus_data:
    driver: local
    name: milvus_data
  etcd_data:
    driver: local
    name: etcd_data
  minio_data:
    driver: local
    name: minio_data